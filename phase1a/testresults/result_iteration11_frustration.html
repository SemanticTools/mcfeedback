<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>mcfeedback — Iteration 11: Synapse Frustration Flip</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0f1117; color: #d0d0d0; padding: 32px 28px; max-width: 1000px; margin: 0 auto; }
  h1 { font-size: 1.5rem; font-weight: 700; color: #fff; margin-bottom: 4px; }
  .subtitle { font-size: 0.85rem; color: #555; margin-bottom: 36px; }
  h2 { font-size: 0.95rem; font-weight: 700; color: #aaa; margin: 36px 0 14px; border-bottom: 1px solid #1e2130; padding-bottom: 7px; text-transform: uppercase; letter-spacing: 0.06em; }
  .card { background: #1a1d27; border: 1px solid #2a2d3a; border-radius: 8px; padding: 20px 24px; margin-bottom: 20px; }
  canvas { width: 100% !important; }
  table { border-collapse: collapse; width: 100%; font-size: 0.83rem; }
  th { background: #1e2130; color: #777; font-weight: 600; text-align: left; padding: 9px 14px; border-bottom: 2px solid #2a2d3a; }
  td { padding: 8px 14px; border-bottom: 1px solid #161920; }
  .meta { font-size: 0.78rem; color: #444; margin-top: 10px; }
  .verdict { border: 1px solid #2a2d3a; border-radius: 6px; padding: 18px 22px; margin-bottom: 20px; font-size: 0.9rem; line-height: 1.7; }
  .verdict strong { color: #fff; }
  .verdict.red    { border-color: #3a2222; background: #1a1215; }
  .verdict.yellow { border-color: #3a3020; background: #181510; }
  .verdict.blue   { border-color: #1e2a3a; background: #111520; }
  .verdict.green  { border-color: #1e3a22; background: #111a13; }
  .legend { display: flex; gap: 18px; flex-wrap: wrap; margin-bottom: 18px; }
  .leg { display: flex; align-items: center; gap: 7px; font-size: 0.82rem; color: #aaa; }
  .dot { width: 11px; height: 11px; border-radius: 50%; flex-shrink: 0; }
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .param-change { font-family: monospace; font-size: 0.82rem; background: #1a1d27; border: 1px solid #2a2d3a; border-radius: 5px; padding: 12px 16px; margin-bottom: 20px; color: #aaa; line-height: 1.9; }
  .param-change .new { color: #76b7b2; }
  .param-change .note { color: #555; }
  @media (max-width: 680px) { .two-col { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<h1>mcfeedback — Iteration 11: Synapse Frustration Flip</h1>
<div class="subtitle">
  experiment-011.mjs &nbsp;·&nbsp;
  N = 10 seeds &nbsp;·&nbsp;
  Seeds: 42, 137, 271, 314, 500, 618, 777, 888, 999, 1234 &nbsp;·&nbsp;
  1000 training episodes &nbsp;·&nbsp;
  Frozen-weight evaluation &nbsp;·&nbsp;
  Base: experiment-004 (no direction-consistent flags, no propagation cycles)
</div>

<div class="param-change">
  <strong style="color:#fff">New mechanism — per-synapse frustration detection (Full model only):</strong><br>
  Each synapse tracks same-direction weight movement and its average chemical reward during that period.<br>
  <span class="new">frustrationWindow &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;30</span> &nbsp;<span class="note">— consecutive same-direction steps before check activates</span><br>
  <span class="new">frustrationThreshold &nbsp;&nbsp;−0.1</span> &nbsp;<span class="note">— rewardWhileAdjusting below this triggers a flip</span><br>
  <span class="new">frustrationFlipStrength &nbsp;0.5</span> &nbsp;<span class="note">— weight = weight × −0.5 on flip (e.g. +0.8 → −0.4)</span><br>
  On flip: flagStrength reset to 0 — synapse must re-earn latch in the new direction.<br>
  <span class="note">Frustration params inactive in Baseline / Ambient only / Dampening only — clean comparison preserved.</span>
</div>

<div class="verdict red">
  <strong>Verdict: frustration flip is significantly worse — p&lt;0.01 for Full model.</strong><br>
  Full model dropped to 48.0% mean (vs 53.0% in experiment-004). The mechanism either
  fires not at all (8/10 seeds: zero flips) or fires catastrophically (2/10 seeds: every
  single synapse flipped). There is no middle ground — it's all-or-nothing.
</div>

<div class="verdict yellow">
  <strong>Key finding: the cascade problem.</strong><br>
  Seeds 500 and 777 triggered a mass-flip event where every synapse in the network was
  eventually flipped (1559/1559 and 1718/1718 respectively). Seed 777 ended up with all
  synapses flipped and <em>zero stable synapses</em> — yet still only scored 45%.
  Seed 500 flipped everything and reached 55%, same as seeds that never flipped at all.<br><br>
  The cascade happens because once some synapses flip, the network dynamics change — the
  previously-stable synapses now receive different inputs and may themselves enter a
  frustrated state. One flip triggers the next. The frustration mechanism is not
  self-limiting: it has no concept of "enough synapses have already changed."
</div>

<div class="legend">
  <div class="leg"><div class="dot" style="background:#4e79a7"></div>Baseline</div>
  <div class="leg"><div class="dot" style="background:#f28e2b"></div>Ambient only</div>
  <div class="leg"><div class="dot" style="background:#e15759"></div>Dampening only</div>
  <div class="leg"><div class="dot" style="background:#76b7b2"></div>Full model</div>
</div>

<h2>1 — Accuracy distribution across seeds</h2>
<div class="card">
  <canvas id="stripChart" height="320"></canvas>
  <p class="meta">Full model: 3 seeds reach 55%, 7 stuck at 45%. Baseline and Dampening only uniformly at 55% — zero variance again. The frustration mechanism is not helping and hurting on balance.</p>
</div>

<h2>2 — Mean ± 1 std</h2>
<div class="card">
  <canvas id="barChart" height="260"></canvas>
  <p class="meta">Full model (48.0% ± 4.8%) is significantly below Baseline (p&lt;0.01). Ambient only (53.0% ± 4.2%) is the best non-Baseline condition — closest to exp-004's Full model peak.</p>
</div>

<div class="two-col">
  <div>
    <h2>3 — Paired t-tests vs Baseline</h2>
    <div class="card" style="padding:0">
    <table>
      <tr><th>Comparison</th><th>Mean diff</th><th>t</th><th>p</th><th>Result</th></tr>
      <tr>
        <td>Ambient only vs Baseline</td>
        <td style="color:#e15759">−2.0%</td>
        <td style="color:#aaa">−1.5</td>
        <td style="color:#aaa">0.1239</td>
        <td style="color:#555;font-weight:600">ns</td>
      </tr>
      <tr>
        <td>Dampening only vs Baseline</td>
        <td style="color:#aaa">+0.0%</td>
        <td style="color:#555">NaN</td>
        <td style="color:#555">—</td>
        <td style="color:#555;font-weight:600">ns</td>
      </tr>
      <tr>
        <td>Full model vs Baseline</td>
        <td style="color:#e15759">−7.0%</td>
        <td style="color:#aaa">−4.5826</td>
        <td style="color:#aaa">0.001</td>
        <td style="color:#e15759;font-weight:600">** p&lt;0.01</td>
      </tr>
    </table>
    </div>
    <p class="meta" style="margin-top:8px">Two-tailed paired t-test, df=9. Full model is significantly worse. Dampening only t-test undefined (zero variance in both). Note that Full model in exp-004 was +53% — frustration has degraded it by 5 percentage points.</p>
  </div>

  <div>
    <h2>4 — Raw data (all seeds)</h2>
    <div class="card" style="padding:0">
    <table>
      <tr><th>Seed</th><th>Baseline</th><th>Ambient</th><th>Dampening</th><th>Full</th></tr>
      <tr><td style="color:#555">42</td>   <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td></tr>
      <tr><td style="color:#555">137</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td></tr>
      <tr><td style="color:#555">271</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td></tr>
      <tr><td style="color:#555">314</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td></tr>
      <tr><td style="color:#555">500</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td></tr>
      <tr><td style="color:#555">618</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td></tr>
      <tr><td style="color:#555">777</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td></tr>
      <tr><td style="color:#555">888</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td></tr>
      <tr><td style="color:#555">999</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td></tr>
      <tr><td style="color:#555">1234</td> <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td></tr>
      <tr style="border-top:2px solid #2a2d3a">
        <td style="color:#aaa;font-weight:600">Mean</td>
        <td style="color:#fff;font-weight:600">55.0%</td>
        <td style="color:#fff;font-weight:600">53.0%</td>
        <td style="color:#fff;font-weight:600">55.0%</td>
        <td style="color:#fff;font-weight:600">48.0%</td>
      </tr>
      <tr>
        <td style="color:#555">Std</td>
        <td style="color:#555">±0.0%</td>
        <td style="color:#555">±4.2%</td>
        <td style="color:#555">±0.0%</td>
        <td style="color:#555">±4.8%</td>
      </tr>
    </table>
    </div>
  </div>
</div>

<h2>5 — Per-pattern accuracy (mean across seeds)</h2>
<div class="card">
  <canvas id="patternChart" height="260"></canvas>
  <p class="meta">Full model gains on P1 (54%) but loses on P2–P4 (46% each). Same bias pattern seen in experiments 010 and 010b — the Full model conditions are systematically biasing toward one output pattern.</p>
</div>

<h2>6 — Frustration flip diagnostic (Full model)</h2>
<div class="card" style="padding:0">
<table>
  <tr><th>Seed</th><th>Total Flips</th><th>Flipped Synapses</th><th>Mean |w| flipped</th><th>Mean |w| stable</th><th>Final Acc</th></tr>
  <tr>
    <td style="color:#555">42</td>
    <td style="color:#555">0</td><td style="color:#555">0</td>
    <td style="color:#555">—</td><td>0.2869</td>
    <td style="color:#e15759">45%</td>
  </tr>
  <tr>
    <td style="color:#555">137</td>
    <td style="color:#555">0</td><td style="color:#555">0</td>
    <td style="color:#555">—</td><td>0.1133</td>
    <td style="color:#e15759">45%</td>
  </tr>
  <tr>
    <td style="color:#555">271</td>
    <td style="color:#555">0</td><td style="color:#555">0</td>
    <td style="color:#555">—</td><td>0.2592</td>
    <td style="color:#e15759">45%</td>
  </tr>
  <tr>
    <td style="color:#555">314</td>
    <td style="color:#555">0</td><td style="color:#555">0</td>
    <td style="color:#555">—</td><td>0.5497</td>
    <td style="color:#888">55%</td>
  </tr>
  <tr style="background:#1e1510">
    <td style="color:#f28e2b">500</td>
    <td style="color:#f28e2b">1559</td><td style="color:#f28e2b">1559 / 1559</td>
    <td>0.4282</td><td style="color:#555">— (none)</td>
    <td style="color:#888">55%</td>
  </tr>
  <tr>
    <td style="color:#555">618</td>
    <td style="color:#555">0</td><td style="color:#555">0</td>
    <td style="color:#555">—</td><td>0.1110</td>
    <td style="color:#e15759">45%</td>
  </tr>
  <tr style="background:#1e1510">
    <td style="color:#f28e2b">777</td>
    <td style="color:#f28e2b">1718</td><td style="color:#f28e2b">1718 / 1718</td>
    <td>0.2350</td><td style="color:#555">— (none)</td>
    <td style="color:#e15759">45%</td>
  </tr>
  <tr>
    <td style="color:#555">888</td>
    <td style="color:#555">0</td><td style="color:#555">0</td>
    <td style="color:#555">—</td><td>0.6084</td>
    <td style="color:#888">55%</td>
  </tr>
  <tr>
    <td style="color:#555">999</td>
    <td style="color:#555">0</td><td style="color:#555">0</td>
    <td style="color:#555">—</td><td>0.1249</td>
    <td style="color:#e15759">45%</td>
  </tr>
  <tr>
    <td style="color:#555">1234</td>
    <td style="color:#555">0</td><td style="color:#555">0</td>
    <td style="color:#555">—</td><td>0.0951</td>
    <td style="color:#e15759">45%</td>
  </tr>
</table>
</div>
<p class="meta" style="margin-bottom:20px">Seeds 500 and 777: every synapse in the network was flipped (full cascade). Seed 777 reached 45% — mass flipping didn't help. Seed 500 reached 55%, same as seeds that never flipped. The 8 non-flipping seeds either stayed stuck (45%) or succeeded without needing the mechanism (314, 888).</p>

<div class="verdict yellow">
  <strong>Why the cascade happens:</strong><br>
  The frustration window (30 steps) is short relative to the 1000-episode training run.
  Once the first synapses flip, they deliver different inputs to their downstream partners.
  Those partners now receive changed pre-synaptic signals — their own adjustment histories
  become misaligned with their new inputs. They satisfy the frustration condition themselves
  and flip. Each wave of flips destabilises the next layer. Because there is no global
  "network has already reorganised" signal to suppress further flips, the cascade
  propagates until every synapse has flipped at least once.
  <br><br>
  The mechanism needs a self-limiting property — for example, a refractory period after
  a flip, or a global frustration budget that gets depleted. Without one, the flip
  behaves like a runaway local optimiser.
</div>

<div class="verdict blue">
  <strong>Progress across iterations (Full model mean):</strong><br>
  Iter 4 (flag gate):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;53.0% &nbsp;max 65% &nbsp;← best mean<br>
  Iter 6 (flag + anneal):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;51.0% &nbsp;max 65%<br>
  Iter 10 (direction-consistent):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;49.0% &nbsp;max 65%<br>
  Iter 11 (frustration flip):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;48.0% &nbsp;max 55% &nbsp;← cascade problem<br><br>
  <strong>Consistent pattern:</strong> every modification to the learning gate or weight-adjustment
  mechanism has degraded the Full model mean below experiment-004's 53%.
  The mechanisms introduced are each sound in isolation, but interact with the
  recurrent, all-to-all topology in ways that cause network-wide instability.<br><br>
  <strong>Notable:</strong> the frustration diagnostic reveals that 6/10 seeds have very low mean
  weight magnitude (0.09–0.28) — the network hasn't learned much at all.
  Seeds 314 (0.55) and 888 (0.61) are the only ones with substantial weight buildup,
  and they're the two that reach 55% without any flips.<br><br>
  <strong>Hypothesis for next iteration:</strong> the weight magnitudes suggest most seeds never
  build up enough weight to produce reliable output. The flag gate (|flagStrength| ≥ 0.5)
  may be gating too aggressively — the learning signal is too weak to push past the
  threshold before weight decay erases it. Consider lowering weightDecay or the flag
  threshold, or removing the flag gate entirely and testing the raw reward signal.
</div>

<script>
const COLORS = ["#4e79a7","#f28e2b","#e15759","#76b7b2"];
const LABELS = ["Baseline","Ambient only","Dampening only","Full model"];

const stripData = [
  { label: "Baseline",       color: "#4e79a7", values: [55,55,55,55,55,55,55,55,55,55], mean: 55.0, std: 0.0 },
  { label: "Ambient only",   color: "#f28e2b", values: [55,45,55,55,45,55,55,55,55,55], mean: 53.0, std: 4.2 },
  { label: "Dampening only", color: "#e15759", values: [55,55,55,55,55,55,55,55,55,55], mean: 55.0, std: 0.0 },
  { label: "Full model",     color: "#76b7b2", values: [45,45,45,55,55,45,45,55,45,45], mean: 48.0, std: 4.8 },
];

const patternChartData = {
  labels: ["P1","P2","P3","P4"],
  datasets: [
    { label: "Baseline",       data: [40,60,60,60], backgroundColor: "#4e79a7cc", borderColor: "#4e79a7", borderWidth: 1 },
    { label: "Ambient only",   data: [44,56,56,56], backgroundColor: "#f28e2bcc", borderColor: "#f28e2b", borderWidth: 1 },
    { label: "Dampening only", data: [40,60,60,60], backgroundColor: "#e15759cc", borderColor: "#e15759", borderWidth: 1 },
    { label: "Full model",     data: [54,46,46,46], backgroundColor: "#76b7b2cc", borderColor: "#76b7b2", borderWidth: 1 },
  ]
};

// ── Strip chart ───────────────────────────────────────────────────────────
const scatterSets = stripData.map((d, ci) => ({
  type: 'scatter', label: d.label,
  data: d.values.map(v => ({ x: ci + 1 + (Math.random()-0.5)*0.18, y: v })),
  backgroundColor: COLORS[ci] + 'bb', borderColor: COLORS[ci],
  borderWidth: 1, pointRadius: 6, pointHoverRadius: 8, showLine: false,
}));
const meanSets = stripData.map((d, ci) => ({
  type: 'scatter', label: '_mean_' + ci,
  data: [{ x: ci + 0.7, y: d.mean }, { x: ci + 1.3, y: d.mean }],
  showLine: true, borderColor: COLORS[ci], borderWidth: 3, pointRadius: 0, fill: false,
}));

new Chart(document.getElementById('stripChart').getContext('2d'), {
  type: 'scatter',
  data: { datasets: [...scatterSets, ...meanSets] },
  options: {
    animation: false, responsive: true,
    plugins: {
      legend: { display: false },
      tooltip: { filter: i => !i.dataset.label.startsWith('_'), callbacks: { label: ctx => ' ' + ctx.dataset.label + ': ' + ctx.parsed.y + '%' } },
    },
    scales: {
      x: { min: 0.3, max: 4.7, ticks: { color: '#aaa', callback: v => { const i = Math.round(v)-1; return i>=0&&i<4?LABELS[i]:''; }, stepSize:1, maxTicksLimit:6 }, grid: { color: '#1a1d27' } },
      y: { min: 35, max: 65, title: { display: true, text: 'Accuracy (%)', color: '#555', font: { size: 11 } }, ticks: { color: '#555', callback: v => v+'%' }, grid: { color: ctx => ctx.tick.value===50?'#333':'#1e2130', lineWidth: ctx => ctx.tick.value===50?2:1 } }
    }
  }
});

// ── Bar chart ─────────────────────────────────────────────────────────────
const barPlugin = {
  id: 'errorbars',
  afterDatasetDraw(chart) {
    const { ctx, scales: { x, y } } = chart;
    chart.data.datasets.forEach((ds, di) => {
      if (!ds._stds) return;
      const meta = chart.getDatasetMeta(di);
      meta.data.forEach((bar, i) => {
        const std = ds._stds[i]; if (std==null) return;
        const cx=bar.x, w=6, top=y.getPixelForValue(ds.data[i]+std), bottom=y.getPixelForValue(ds.data[i]-std);
        ctx.save(); ctx.strokeStyle=ds.borderColor[i]||ds.borderColor; ctx.lineWidth=2;
        ctx.beginPath(); ctx.moveTo(cx,top); ctx.lineTo(cx,bottom); ctx.moveTo(cx-w,top); ctx.lineTo(cx+w,top); ctx.moveTo(cx-w,bottom); ctx.lineTo(cx+w,bottom); ctx.stroke(); ctx.restore();
      });
    });
  }
};
new Chart(document.getElementById('barChart').getContext('2d'), {
  type: 'bar', plugins: [barPlugin],
  data: { labels: LABELS, datasets: [{ label:'Mean accuracy', data: stripData.map(d=>d.mean), _stds: stripData.map(d=>d.std), backgroundColor: COLORS.map(c=>c+'88'), borderColor: COLORS, borderWidth:2, borderRadius:4 }] },
  options: {
    animation: false, responsive: true,
    plugins: { legend:{display:false}, tooltip:{callbacks:{label:ctx=>' Mean: '+ctx.parsed.y.toFixed(1)+'%'}} },
    scales: {
      x: { ticks:{color:'#aaa'}, grid:{color:'#1a1d27'} },
      y: { min:35, max:65, title:{display:true,text:'Mean accuracy (%)',color:'#555',font:{size:11}}, ticks:{color:'#555',callback:v=>v+'%'}, grid:{color:ctx=>ctx.tick.value===50?'#333':'#1e2130',lineWidth:ctx=>ctx.tick.value===50?2:1} }
    }
  }
});

// ── Per-pattern bar ───────────────────────────────────────────────────────
new Chart(document.getElementById('patternChart'), {
  type: 'bar', data: patternChartData,
  options: {
    animation: false, responsive: true,
    plugins: { legend:{labels:{color:'#aaa',font:{size:11},boxWidth:12}}, tooltip:{callbacks:{label:ctx=>' '+ctx.dataset.label+': '+ctx.parsed.y.toFixed(1)+'%'}} },
    scales: {
      x: { ticks:{color:'#aaa'}, grid:{color:'#1a1d27'} },
      y: { min:30, max:70, title:{display:true,text:'Mean accuracy (%)',color:'#555',font:{size:11}}, ticks:{color:'#555',callback:v=>v+'%'}, grid:{color:ctx=>ctx.tick.value===50?'#333':'#1e2130',lineWidth:ctx=>ctx.tick.value===50?2:1} }
    }
  }
});
</script>
</body>
</html>
