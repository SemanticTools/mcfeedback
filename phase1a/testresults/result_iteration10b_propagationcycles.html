<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>mcfeedback — Iteration 10b: Propagation Cycles</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0f1117; color: #d0d0d0; padding: 32px 28px; max-width: 1000px; margin: 0 auto; }
  h1 { font-size: 1.5rem; font-weight: 700; color: #fff; margin-bottom: 4px; }
  .subtitle { font-size: 0.85rem; color: #555; margin-bottom: 36px; }
  h2 { font-size: 0.95rem; font-weight: 700; color: #aaa; margin: 36px 0 14px; border-bottom: 1px solid #1e2130; padding-bottom: 7px; text-transform: uppercase; letter-spacing: 0.06em; }
  .card { background: #1a1d27; border: 1px solid #2a2d3a; border-radius: 8px; padding: 20px 24px; margin-bottom: 20px; }
  canvas { width: 100% !important; }
  table { border-collapse: collapse; width: 100%; font-size: 0.83rem; }
  th { background: #1e2130; color: #777; font-weight: 600; text-align: left; padding: 9px 14px; border-bottom: 2px solid #2a2d3a; }
  td { padding: 8px 14px; border-bottom: 1px solid #161920; }
  .meta { font-size: 0.78rem; color: #444; margin-top: 10px; }
  .verdict { border: 1px solid #2a2d3a; border-radius: 6px; padding: 18px 22px; margin-bottom: 20px; font-size: 0.9rem; line-height: 1.7; }
  .verdict strong { color: #fff; }
  .verdict.red    { border-color: #3a2222; background: #1a1215; }
  .verdict.yellow { border-color: #3a3020; background: #181510; }
  .verdict.blue   { border-color: #1e2a3a; background: #111520; }
  .verdict.green  { border-color: #1e3a22; background: #111a13; }
  .legend { display: flex; gap: 18px; flex-wrap: wrap; margin-bottom: 18px; }
  .leg { display: flex; align-items: center; gap: 7px; font-size: 0.82rem; color: #aaa; }
  .dot { width: 11px; height: 11px; border-radius: 50%; flex-shrink: 0; }
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .param-change { font-family: monospace; font-size: 0.82rem; background: #1a1d27; border: 1px solid #2a2d3a; border-radius: 5px; padding: 12px 16px; margin-bottom: 20px; color: #aaa; line-height: 1.9; }
  .param-change .new { color: #76b7b2; }
  .param-change .note { color: #555; }
  @media (max-width: 680px) { .two-col { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<h1>mcfeedback — Iteration 10b: Propagation Cycles</h1>
<div class="subtitle">
  experiment-010b.mjs &nbsp;·&nbsp;
  N = 10 seeds &nbsp;·&nbsp;
  Seeds: 42, 137, 271, 314, 500, 618, 777, 888, 999, 1234 &nbsp;·&nbsp;
  1000 training episodes &nbsp;·&nbsp;
  Frozen-weight evaluation &nbsp;·&nbsp;
  Random chance = 50%
</div>

<!-- Parameter block -->
<div class="param-change">
  <strong style="color:#fff">Change from experiment-010:</strong> run 3 accumulate-and-fire cycles per training step.<br>
  <span class="new">propagationCycles &nbsp;3</span> &nbsp;<span class="note">— forward pass runs 3× before flagging/learning; all other params from exp-010</span><br>
  consistencyThreshold &nbsp;5 &nbsp;·&nbsp; flagStrengthGain &nbsp;0.15 &nbsp;·&nbsp; flagDecayOnFlip &nbsp;0.5 &nbsp;·&nbsp; flagDecayRate &nbsp;0.9 &nbsp;<span class="note">(unchanged)</span>
</div>

<!-- Verdict -->
<div class="verdict red">
  <strong>Verdict: propagationCycles=3 is significantly worse — p&lt;0.01 for Full model.</strong><br>
  Full model dropped to 46.5% mean (vs 49.0% in exp-010, vs 53.0% in exp-004).
  Ambient only is now also significantly worse (p&lt;0.05).
  Only seed 888 escaped at 65%; the other 9 seeds are stuck at 40–45%.
</div>

<!-- Key finding -->
<div class="verdict green">
  <strong>Key finding: flag saturation is finally broken — but accuracy is not improving.</strong><br>
  Ep-500 latch rates are now 25–81%, down from 87–93% in exp-010 and uniformly 90%+ in exp-008.
  The additional propagation cycles are creating more direction flips in the eligibility traces
  (signals bounce through the recurrent graph 3× instead of 1×), which penalises streak-building
  and prevents the flags from saturating. This is the selective pressure we were looking for.<br><br>
  The problem: seed 888 (65% final, 32.9% latch) confirms the pattern — lower saturation
  correlates with better performance. But the other 9 seeds still get 45% even with low latch
  rates (25–53%). Something else is blocking them.
</div>

<div class="legend">
  <div class="leg"><div class="dot" style="background:#4e79a7"></div>Baseline</div>
  <div class="leg"><div class="dot" style="background:#f28e2b"></div>Ambient only</div>
  <div class="leg"><div class="dot" style="background:#e15759"></div>Dampening only</div>
  <div class="leg"><div class="dot" style="background:#76b7b2"></div>Full model</div>
</div>

<h2>1 — Accuracy distribution across seeds</h2>
<div class="card">
  <canvas id="stripChart" height="320"></canvas>
  <p class="meta">Full model: one outlier at 65% (seed 888), rest collapsed to 40–45%. Baseline still uniformly 55% — the reward pathway alone can find a stable attractor but the Full model cannot.</p>
</div>

<h2>2 — Mean ± 1 std</h2>
<div class="card">
  <canvas id="barChart" height="260"></canvas>
  <p class="meta">Full model (46.5% ± 6.7%) is significantly below Baseline (p&lt;0.01). Ambient only also significantly degraded. Dampening only (53% ± 6.3%) is the best non-Baseline condition.</p>
</div>

<div class="two-col">
  <div>
    <h2>3 — Paired t-tests vs Baseline</h2>
    <div class="card" style="padding:0">
    <table>
      <tr><th>Comparison</th><th>Mean diff</th><th>t</th><th>p</th><th>Result</th></tr>
      <tr>
        <td>Ambient only vs Baseline</td>
        <td style="color:#e15759">−4.0%</td>
        <td style="color:#aaa">−2.4495</td>
        <td style="color:#aaa">0.0271</td>
        <td style="color:#e15759;font-weight:600">* p&lt;0.05</td>
      </tr>
      <tr>
        <td>Dampening only vs Baseline</td>
        <td style="color:#e15759">−2.0%</td>
        <td style="color:#aaa">−1.0</td>
        <td style="color:#aaa">0.2534</td>
        <td style="color:#555;font-weight:600">ns</td>
      </tr>
      <tr>
        <td>Full model vs Baseline</td>
        <td style="color:#e15759">−8.5%</td>
        <td style="color:#aaa">−4.0194</td>
        <td style="color:#aaa">0.0022</td>
        <td style="color:#e15759;font-weight:600">** p&lt;0.01</td>
      </tr>
    </table>
    </div>
    <p class="meta" style="margin-top:8px">Two-tailed paired t-test, df=9. Strongest negative effect yet for Full model (p&lt;0.01). Multiple propagation cycles appear to destabilise the ambient + dampening + chemical combination.</p>
  </div>

  <div>
    <h2>4 — Raw data (all seeds)</h2>
    <div class="card" style="padding:0">
    <table>
      <tr><th>Seed</th><th>Baseline</th><th>Ambient</th><th>Dampening</th><th>Full</th></tr>
      <tr><td style="color:#555">42</td>   <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td></tr>
      <tr><td style="color:#555">137</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td></tr>
      <tr><td style="color:#555">271</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td></tr>
      <tr><td style="color:#555">314</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td></tr>
      <tr><td style="color:#555">500</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td></tr>
      <tr><td style="color:#555">618</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">40%</td></tr>
      <tr><td style="color:#555">777</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">35%</td>  <td style="color:#e15759">45%</td></tr>
      <tr><td style="color:#555">888</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td>  <td style="color:#888">55%</td>  <td style="color:#76b7b2">65%</td></tr>
      <tr><td style="color:#555">999</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td></tr>
      <tr><td style="color:#555">1234</td> <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td>  <td style="color:#888">55%</td>  <td style="color:#e15759">45%</td></tr>
      <tr style="border-top:2px solid #2a2d3a">
        <td style="color:#aaa;font-weight:600">Mean</td>
        <td style="color:#fff;font-weight:600">55.0%</td>
        <td style="color:#fff;font-weight:600">51.0%</td>
        <td style="color:#fff;font-weight:600">53.0%</td>
        <td style="color:#fff;font-weight:600">46.5%</td>
      </tr>
      <tr>
        <td style="color:#555">Std</td>
        <td style="color:#555">±0.0%</td>
        <td style="color:#555">±5.2%</td>
        <td style="color:#555">±6.3%</td>
        <td style="color:#555">±6.7%</td>
      </tr>
    </table>
    </div>
  </div>
</div>

<h2>5 — Per-pattern accuracy (mean across seeds)</h2>
<div class="card">
  <canvas id="patternChart" height="260"></canvas>
  <p class="meta">Full model P2 at 34% — well below chance. P1 at 62% compensates. The network is strongly biasing toward one output pattern regardless of input.</p>
</div>

<h2>6 — Ep-500 flag latch diagnostic (Full model, output-bound synapses)</h2>
<div class="card">
  <canvas id="latchChart" height="260"></canvas>
  <p class="meta">
    <strong style="color:#76b7b2">Major improvement in selectivity:</strong> latch rates dropped to 25–81%, down from 87–93% in exp-010.
    The 3 propagation cycles create more direction flips in eligibility traces, making the 5-streak
    requirement genuinely hard to satisfy. Seed 888 (65% final acc, 32.9% latch) confirms
    the hypothesis — lower saturation → better performance. But seeds with 25–53% latch
    still score only 45%, suggesting that low latch alone is not sufficient.
  </p>
</div>

<div class="card" style="padding:0">
<table>
  <tr><th>Seed</th><th>Latched / Total</th><th>Latch %</th><th>Mean |f|</th><th>Final Acc</th></tr>
  <tr><td style="color:#555">42</td>   <td>131 / 162</td> <td style="color:#f28e2b">80.9%</td> <td>0.696</td> <td style="color:#e15759">45%</td></tr>
  <tr><td style="color:#555">137</td>  <td>58 / 166</td>  <td style="color:#76b7b2">34.9%</td> <td>0.408</td> <td style="color:#e15759">45%</td></tr>
  <tr><td style="color:#555">271</td>  <td>83 / 157</td>  <td style="color:#888">52.9%</td>    <td>0.513</td> <td style="color:#e15759">45%</td></tr>
  <tr><td style="color:#555">314</td>  <td>104 / 141</td> <td style="color:#f28e2b">73.8%</td> <td>0.817</td> <td style="color:#e15759">45%</td></tr>
  <tr><td style="color:#555">500</td>  <td>65 / 153</td>  <td style="color:#76b7b2">42.5%</td> <td>0.443</td> <td style="color:#e15759">45%</td></tr>
  <tr><td style="color:#555">618</td>  <td>104 / 171</td> <td style="color:#888">60.8%</td>    <td>0.611</td> <td style="color:#e15759">40%</td></tr>
  <tr><td style="color:#555">777</td>  <td>55 / 168</td>  <td style="color:#76b7b2">32.7%</td> <td>0.435</td> <td style="color:#e15759">45%</td></tr>
  <tr><td style="color:#555">888</td>  <td>51 / 155</td>  <td style="color:#76b7b2">32.9%</td> <td>0.411</td> <td style="color:#76b7b2">65%</td></tr>
  <tr><td style="color:#555">999</td>  <td>70 / 151</td>  <td style="color:#888">46.4%</td>    <td>0.524</td> <td style="color:#e15759">45%</td></tr>
  <tr><td style="color:#555">1234</td> <td>38 / 150</td>  <td style="color:#76b7b2">25.3%</td> <td>0.389</td> <td style="color:#e15759">45%</td></tr>
</table>
</div>

<div class="verdict yellow">
  <strong>Why low latch + 3 cycles still fails:</strong><br>
  With 3 propagation cycles, signals bounce through the recurrent graph multiple times
  per step. This means output neurons receive compound, amplified signals — the same
  weight that produced a weak mismatch in 1 cycle may produce a strong one in 3.
  The eligibility traces become noisier, direction flips multiply, and the flag gate
  blocks too many synapses. The network can't stabilise because the chemical reward
  signal and the flag gate are both disrupted by the extra propagation noise.
  Seed 888 happened to have a topology where 3 cycles helped; the others were hurt.
</div>

<div class="verdict blue">
  <strong>Progress across iterations (Full model mean):</strong><br>
  Iter 4 (flag gate):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;53.0% &nbsp;max 65% &nbsp;← best mean<br>
  Iter 6 (flag + anneal):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;51.0% &nbsp;max 65%<br>
  Iter 10 (direction-consistent): &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;49.0% &nbsp;max 65%<br>
  Iter 10b (+ propagationCycles=3): &nbsp;&nbsp;&nbsp;&nbsp;46.5% &nbsp;max 65%<br><br>
  <strong>What 10b confirms:</strong> more propagation cycles successfully break flag saturation
  (25–81% vs 87–93%) — this is mechanistically useful. But propagation noise hurts the
  overall system. The path forward is likely to find propagationCycles that reduces
  saturation without introducing noise — or to separate the propagation and flagging concerns.
  <br><br>
  <strong>Candidate next steps:</strong><br>
  &nbsp;A) Try propagationCycles=2 — less noise, still more signal reach<br>
  &nbsp;B) Revert to exp-004 flags (gain=0.3) + propagationCycles=3 — isolate which change helps<br>
  &nbsp;C) Diagnose why Baseline is stuck at 55% ceiling — the learning rule itself may be the bottleneck
</div>

<script>
const COLORS = ["#4e79a7","#f28e2b","#e15759","#76b7b2"];
const LABELS = ["Baseline","Ambient only","Dampening only","Full model"];

const stripData = [
  { label: "Baseline",       color: "#4e79a7", values: [55,55,55,55,55,55,55,55,55,55], mean: 55.0, std: 0.0 },
  { label: "Ambient only",   color: "#f28e2b", values: [45,55,55,55,45,55,55,45,55,45], mean: 51.0, std: 5.2 },
  { label: "Dampening only", color: "#e15759", values: [55,55,55,55,55,55,35,55,55,55], mean: 53.0, std: 6.3 },
  { label: "Full model",     color: "#76b7b2", values: [45,45,45,45,45,40,45,65,45,45], mean: 46.5, std: 6.7 },
];

const patternChartData = {
  labels: ["P1","P2","P3","P4"],
  datasets: [
    { label: "Baseline",       data: [40,60,60,60], backgroundColor: "#4e79a7cc", borderColor: "#4e79a7", borderWidth: 1 },
    { label: "Ambient only",   data: [52,50,52,50], backgroundColor: "#f28e2bcc", borderColor: "#f28e2b", borderWidth: 1 },
    { label: "Dampening only", data: [42,54,58,58], backgroundColor: "#e15759cc", borderColor: "#e15759", borderWidth: 1 },
    { label: "Full model",     data: [62,34,50,40], backgroundColor: "#76b7b2cc", borderColor: "#76b7b2", borderWidth: 1 },
  ]
};

// ── Strip chart ───────────────────────────────────────────────────────────
const scatterSets = stripData.map((d, ci) => ({
  type: 'scatter', label: d.label,
  data: d.values.map(v => ({ x: ci + 1 + (Math.random()-0.5)*0.18, y: v })),
  backgroundColor: COLORS[ci] + 'bb', borderColor: COLORS[ci],
  borderWidth: 1, pointRadius: 6, pointHoverRadius: 8, showLine: false,
}));
const meanSets = stripData.map((d, ci) => ({
  type: 'scatter', label: '_mean_' + ci,
  data: [{ x: ci + 0.7, y: d.mean }, { x: ci + 1.3, y: d.mean }],
  showLine: true, borderColor: COLORS[ci], borderWidth: 3, pointRadius: 0, fill: false,
}));

new Chart(document.getElementById('stripChart').getContext('2d'), {
  type: 'scatter',
  data: { datasets: [...scatterSets, ...meanSets] },
  options: {
    animation: false, responsive: true,
    plugins: {
      legend: { display: false },
      tooltip: { filter: i => !i.dataset.label.startsWith('_'), callbacks: { label: ctx => ' ' + ctx.dataset.label + ': ' + ctx.parsed.y + '%' } },
    },
    scales: {
      x: { min: 0.3, max: 4.7, ticks: { color: '#aaa', callback: v => { const i = Math.round(v)-1; return i>=0&&i<4?LABELS[i]:''; }, stepSize:1, maxTicksLimit:6 }, grid: { color: '#1a1d27' } },
      y: { min: 25, max: 75, title: { display: true, text: 'Accuracy (%)', color: '#555', font: { size: 11 } }, ticks: { color: '#555', callback: v => v+'%' }, grid: { color: ctx => ctx.tick.value===50?'#333':'#1e2130', lineWidth: ctx => ctx.tick.value===50?2:1 } }
    }
  }
});

// ── Bar chart ─────────────────────────────────────────────────────────────
const barPlugin = {
  id: 'errorbars',
  afterDatasetDraw(chart) {
    const { ctx, scales: { x, y } } = chart;
    chart.data.datasets.forEach((ds, di) => {
      if (!ds._stds) return;
      const meta = chart.getDatasetMeta(di);
      meta.data.forEach((bar, i) => {
        const std = ds._stds[i]; if (std==null) return;
        const cx=bar.x, w=6, top=y.getPixelForValue(ds.data[i]+std), bottom=y.getPixelForValue(ds.data[i]-std);
        ctx.save(); ctx.strokeStyle=ds.borderColor[i]||ds.borderColor; ctx.lineWidth=2;
        ctx.beginPath(); ctx.moveTo(cx,top); ctx.lineTo(cx,bottom); ctx.moveTo(cx-w,top); ctx.lineTo(cx+w,top); ctx.moveTo(cx-w,bottom); ctx.lineTo(cx+w,bottom); ctx.stroke(); ctx.restore();
      });
    });
  }
};
new Chart(document.getElementById('barChart').getContext('2d'), {
  type: 'bar', plugins: [barPlugin],
  data: { labels: LABELS, datasets: [{ label:'Mean accuracy', data: stripData.map(d=>d.mean), _stds: stripData.map(d=>d.std), backgroundColor: COLORS.map(c=>c+'88'), borderColor: COLORS, borderWidth:2, borderRadius:4 }] },
  options: {
    animation: false, responsive: true,
    plugins: { legend:{display:false}, tooltip:{callbacks:{label:ctx=>' Mean: '+ctx.parsed.y.toFixed(1)+'%'}} },
    scales: {
      x: { ticks:{color:'#aaa'}, grid:{color:'#1a1d27'} },
      y: { min:30, max:70, title:{display:true,text:'Mean accuracy (%)',color:'#555',font:{size:11}}, ticks:{color:'#555',callback:v=>v+'%'}, grid:{color:ctx=>ctx.tick.value===50?'#333':'#1e2130',lineWidth:ctx=>ctx.tick.value===50?2:1} }
    }
  }
});

// ── Per-pattern bar ───────────────────────────────────────────────────────
new Chart(document.getElementById('patternChart'), {
  type: 'bar', data: patternChartData,
  options: {
    animation: false, responsive: true,
    plugins: { legend:{labels:{color:'#aaa',font:{size:11},boxWidth:12}}, tooltip:{callbacks:{label:ctx=>' '+ctx.dataset.label+': '+ctx.parsed.y.toFixed(1)+'%'}} },
    scales: {
      x: { ticks:{color:'#aaa'}, grid:{color:'#1a1d27'} },
      y: { min:20, max:75, title:{display:true,text:'Mean accuracy (%)',color:'#555',font:{size:11}}, ticks:{color:'#555',callback:v=>v+'%'}, grid:{color:ctx=>ctx.tick.value===50?'#333':'#1e2130',lineWidth:ctx=>ctx.tick.value===50?2:1} }
    }
  }
});

// ── Ep-500 latch chart ────────────────────────────────────────────────────
const SEEDS      = [42, 137, 271, 314, 500, 618, 777, 888, 999, 1234];
const latchPcts  = [80.9, 34.9, 52.9, 73.8, 42.5, 60.8, 32.7, 32.9, 46.4, 25.3];
const finalAccs  = [45,   45,   45,   45,   45,   40,   45,   65,   45,   45  ];
const latchColors = latchPcts.map(p => p < 50 ? '#76b7b2cc' : p < 70 ? '#f28e2bcc' : '#e15759cc');
const latchBorders = latchPcts.map(p => p < 50 ? '#76b7b2' : p < 70 ? '#f28e2b' : '#e15759');

new Chart(document.getElementById('latchChart'), {
  type: 'bar',
  data: {
    labels: SEEDS.map((s, i) => `Seed ${s}\n(${finalAccs[i]}%)`),
    datasets: [{
      label: 'Latched % at ep 500',
      data: latchPcts,
      backgroundColor: latchColors,
      borderColor: latchBorders,
      borderWidth: 2,
      borderRadius: 3,
    }]
  },
  options: {
    animation: false, responsive: true,
    plugins: {
      legend: { display: false },
      tooltip: { callbacks: { label: ctx => ` Latched: ${ctx.parsed.y}% (final acc: ${finalAccs[ctx.dataIndex]}%)` } }
    },
    scales: {
      x: { ticks: { color: '#aaa', font: { size: 10 } }, grid: { color: '#1a1d27' } },
      y: {
        min: 0, max: 100,
        title: { display: true, text: '% output-bound synapses latched (ep 500)', color: '#555', font: { size: 11 } },
        ticks: { color: '#555', callback: v => v + '%' },
        grid: { color: ctx => ctx.tick.value === 50 ? '#333' : '#1e2130' }
      }
    }
  }
});
</script>
</body>
</html>
